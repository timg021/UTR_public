Brief description of the "inverse" simulation (3D object reconstruction) module "PhaseRetrieval.exe"
of the Differential Holographic Tomography (DHT) software package

PhaseRetrieval.exe module performs 3D object reconstruction and reprojection tasks, 
using the DHT algorithm with input data (defocused images) that have been collected in an experiment
or generated by the MsctKirkland.exe module. This program has been written in C++ and 
can in principle be compiled under any OS supporting  standard C++ compilers and execution environment. 
However, at present the executable module is only available for 64-bit Windows OS. 
Any Windows x64 PC can in principle be used for running this code, but multi-core CPU systems
are recommended for faster execution.

The Euler angle convention corresponds to that in Heymann et al, Journal of Structural Biology 151 (2005) 196–207.
They also correspond to the Euler angles in MsctKirkland program.

Note that several algorithms implemented in this program require the incident intensity to be uniform 1.0. 
Therefore, in general, input images to this program should be already flat-field corrected.

The two main "modes" of execution of PhaseRetrieval.exe correspond to:  
(1) reconstruction of a 3D distribution of the electrostatic potential from defocused 
images (or complex amplitudes) generated by MsctKirkland.exe program for a set of 
different orientations of the imaged object and different defocus distances;
(2) reprojection through a 3D distribution of the electrostatic potential that was either 
generated by MsctKirkland.exe from an XYZ file or, more commonly, was previously reconstructed
by the PhaseRetrieval.exe program itself from defocused images. The result of the reprojection
operation consists of a set of defocused complex amplitudes calculated at the rotational orientations
and defocus distances specified in the text file from Parameter 2 for the input data.
As follows from this description, "mode 2" is not mutually exclusive with "mode 1", and the two
modes can be performed sequentially in a single execution of PhaseRetrieval.exe.

Also, the result of the "reprojection" operation ("mode 2") (a set of defocused complex amplitudes)
can in turn be used as new input for PhaseRetrieval.exe, giving the user an option for manual iteration
of the DHT reconstruction. The latter option can in priniciple be used for iterative refinement of
the DHT reconstruction, however this option has not been fully tested yet at this time.

The control of execution of PhaseRetrieval.exe program is managed via an editable text file 
PhaseRetrieval.txt which contains all modifiable input parameters for PhaseRetrieval.exe. In 
order for the program to run, the input parameter file PhaseRetrieval.txt must be present in 
the same folder where PhaseRetrieval.exe is started from. Alternatively, the name of a suitable input
parameter file can be presented as the first command-line argument (following the PhaseRetrieval.exe
name in the command line) when starting PhaseRetrieval.exe program. In this case, the parameter
file can be given an arbitrary name and can be located in any place accessible from the started
instance of PhaseRetrieval.exe. The format of these input parameter files is fixed and must
comply exactly with the structure described below.

The format of PhaseRetrieval.txt file allows any number of "comment" lines to be present
at the beginning and/or at the end of the file, each such line starting with two forward
slash symbols, "//". The comment lines are ignored by by PhaseRetrieval.exe. Other 
(non-comment) lines must all have the same structure and the fixed sequential order with 
respect to each other. Each non-comment line consists of:
(a) an arbitrary "expression" with no white spaces, which typically represents the name of a 
parameter. The contents of this parameter name expression are ignored by 
PhaseRetrieval.exe. An example of the parameter name 
is "9.Output_defocus_distances_min_max_and_step_in_angstroms:".
(b) one or more alphanumerical entries separated by a single white space from each other 
and from the parameter name, each such entry representing one parameter value, for example 
" -30.0 0.0 0.1171875", which corresponds to three parameter values equal to -30.0, 0.0 and 
0.1171875.
Note that the number of white spaces separating the parameters must be equal to one, 
otherwise a "zero" parameter may be wrongly read in. There should be also no further white 
spaces after the last parameter in the line. Each line should be terminated by the usual "end-
of-line / new line / caret-return", etc., symbols, as common for a given OS. The number and 
types of parameters in each parameter line of the file PhaseRetrieval.txt is pre-determined and 
cannot be changed, only the values of these parameters can be edited. The parameter names 
and comment lines are supposed to give explicit hints as to what type and how many 
parameters are expected in each line. 

Here is a typical example of a valid PhaseRetrieval.txt parameter file.

//*****Input parameter file for PhaseRetrieval.exe program*****
1.Verbose_output_during_execution_Yes(1)_or_No(0): 0
2.Input_file_with_rotation_angles_and_defocus_distances: relion_particle_info_unnormalized__hand_flip.relionnew
3.Optional_file_with_indexes_and_weights_for_subseries_selection_or_NONE: NONE
4.Filename_base_of_defocus_series_in_RAW,_TIFF,_GRD_or_GRC_format: Z:\New_experimental_data_Sep2021\relion_frames_unnormalized\frame_00000.tif
5.HeaderLength(bytes)_Endianness(0=little,1=big)_ElementLength(bytes)_(for_RAW_format): 0 0 4
6.Width_and_height_of_input_images_in_pixels_(lager_images_will_be_trimmed): 512 512
7.Pixel_size_in_Angstroms: 0.457
8.Centre_of_rotation_x,_y_and_z_shifts_in_Angstroms: 0 0 0
9.Input_data_normalization_factors_f1_f2_(input->(input/f1)+f2): 1.0 0.0
10.Wavelength_in_Angstroms: 0.01968749
11.Objective_aperture_(half_angle)_in_mrad: 0.0
12.Spherical_aberration_Cs3,_Cs5_in_mm: 2.7 0.0
13.Absorption_coefficient_(fraction_of_the_real_part): 0.1
14.Phase_retrieval_method_IWFR(1),_CTFL2(2),_-0.5LogAmp(3),_vCTF(4),_or_cCTF(5): 3
15.Apply_Ewald_sphere_curvature_correction:_No(0)_or_Yes(1): 0
16.Save_phase_retrieved_defocused_complex_amplitudes_or_filter_matrix_in_files: 1
17.Maximal_number_of_iterations(IWFR)_or_critical_SNR(sCTF): 200
18.Minimal_phase_error(IWFR),_regularization_parameter(CTFL2,vCTF,cCTF,sCTF)_or_multiplicative_factor(-0.5LogAmp): 0
19.Output_defocus_distances_min_and_max_in_Angstroms: -116.0 116.0
20.Extra_defocus_for_3D_reconstruction_in_Angstroms: 10.0
21.Enforce_symmetry:_not_apply(0),_distribute_input_orientations(1),_post_apply(2): 0
22.Input_file_with_rotation_angles_enforcing_symmetry: Defocus8foldSymmetry.txt
23.Inverse_3D_Laplacian_mode:_not_apply(0)_or_apply(1): 0
24.Regularization_parameter_for_inverse_3D_Laplacian_filter: 0.0
25.Low-pass_filter_width_in_Angstroms,_background_subtraction_value_and_lower_threshold_level_in_Volts: 0.0 0.0 -1000000.0
26.Reprojection_of_3D_potential:_not_apply(0)_or_apply(1): 0
27.Slice_thickness_for_multislice_in_Angstroms: 1.25
28.Peak_localization_mode:_not_apply(0)_or_apply(1): 0
29.Transverse_and_longitudinal_side_lengths_for_peak_localization_in_Angstroms: 0.8 3.2
30.File_name_base_of_3D_potential_in_TIFF_or_GRD_format: C:\Users\tgureyev\Downloads\Temp\Out\out.grd
31.Import_and_reprocess_existing_3D_potential_files:_No(0)_or_Yes(1): 0
32.Folder_name_for_auxiliary_files_output: C:\Users\tgureyev\Downloads\Temp\000temp
33.Number_of_parallel_threads: 20
//*****
//Wavelength_in_Angstroms: E=200 keV <-> 0.02507934, E=300 keV <-> 0.01968749
//*****!!!Don't forget to save this file after editing the parameters

Note that the "numbering" of parameters in the parameter names, such as "19" in 
"19.Output_defocus_distances_min_and_max_in_Angstroms:" is inconsequential and is 
ignored by PhaseRetrieval.exe. On the other hand, the order of the parameter lines in this file 
is very important and must be the same as in the above example. In other words, 
PhaseRetrieval.exe interprets the input parameters according to the order of the non-comment 
lines in the parameter file, while ignoring any numbering that may or may not appear in the 
parameter names.

In the above example, Parameter 1 determines the amount of diagnostic information that PhaseRetrieval.exe 
outputs during the execution. 

Parameter 2 contains the name of an input file with rotation angles and 
defocus distances, which is usually the same file that was previously used by 
MsctKirkland.exe program to generate the set of input defocused images. This file may have one
of two distinct formats which is determined by the file name extenstion. 
(a) If the file name extension is ".txt", the file may contain an
arbitrary number of leading comment lines, each starting with a pair of forward slashes "//". 
Non-comment lines all have the same structure, but may contain different number of entries, 
according to the following scheme. Columns one and two always contain the rotation angles (in degrees)
around the Z and Y' axes, respectively (where Y' axis is the Y axis after the initial rotation
of the 3D space around the Z axis). These two angles are followed by an arbitrary number of pairs
of values, with each odd column (starting from the third one) containing the angle (in degrees)
of rotation around the Z'' axis (Z" axis is the Z axis after the initial rotations
of the 3D space around the Z and Y' axes, which corresponds to the optic axis = illumination direction). 
Each even column (starting from the fourth one) contains a defocus distance in 
angstroms along the Z'' axis. The number of lines in this file is not limited.
An example of a valid "rotation angles and defocus distances" file is given below. 
(b) If the file extension is ".relionnew", then this file contains an arbitrary number of lines,
each line containing exactly ten entries, separated by white spaces, with the following contents:
1st entry contains the sequential number of the line - this parameter is not used
2nd entry contains the name of the file where the data was sourced from - this parameter is not used
3rd entry is the image shift along x in angstroms 
4th entry is the image shift along y in angstroms 
5th entry is the defocus distance dx corresponding to the x coordinate
6th entry is the defocus distance dy corresponding to the y coordinate
7th entry contains the astigmatism angle (alpha) in degrees
8th entry is the rotation angle "rot" around the Z coordinate in degrees
9th entry is the rotation angle "tilt" around the Y' coordinate in degrees
10th entry is the rotation angle "psi" around the Z" coordinate in degrees
A suitable example is given below.
Note that the defocus distances given in this file are considered to be measured from 
the centre of the molecule. Therefore, in order to reconstruct the 3D electrostatic potential inside
the molecule of thickness D, the zmin and zmax values in Parameter 16 should normally be set to
-D/2 and D/2, respectively.
Also, in the case of .relionnew files, all numerical values, except the astigmatism angle (alpha)
are multiplied by (-1) inside the PhaseRetrieval.exe program, because this type of sign flipping has been found
consistent with the treatment of these parameters in RELION.
The text file given in Parameter 2 must be present in the same folder where PhaseRetrieval.exe is started from,
or, alternatively, the filename can include a fully specified pathname (OS specific). 

Parameter 3 contains the pathname of an optional file with indexes and weights for subseries selection or NONE,
if such file is not needed. The subseries selection file should be in a 2-column ASCII format, with the two entries 
in each line separated by a white space. The first column should contain the indexes of the frames to be selected 
(from the set defined by Parameter 2) for processing in this program. The second column should contain relative 
"weights" of these frames. In the DHT reconstruction, the contribution of each frame will be weighted according
to these weights, so the frames (defocused images) with high weights will have larger contribution 
and the frames with low weights will have smaller contibution to the reconstructed 3D potential. All indexes 
in the first column should be within the range for images defined in Parameter 2 (only a single image per
illumination direction is supported for this selection mode). An example of the subseries selection file is given 
at the end of this document.

Parameter 4 contains a fully specified pathname template for the input files containing either 
defocused images (in GRD format, uncompressed 32-bit floating-point TIFF format or a
floating-point RAW file format with an optional header) or defocused
complex amplitudes (in GRC format). Note that this template is used for generation of the eventual
input and output filenames which PhaseRetrieval.exe creates by inserting a single number or a pair of
numbers that correspond to the index of a defocus distance (first inserted number) and the index of a 
rotational orientation (second inserted number). As a result, when a filename template 
"ag.grd" is given in this parameter, the output filenames may look like "ag0_00.grd, 
ag0_01.grd, ..., ag0_35.grd, ag1_00.grd, ..., ag1_35.grd, ag2_00.grd, ..., ag2_35.grd" (36 x 3 
= 108 files in total), if 36 different rotational positions, with 3 defocus distances at each 
rotational position, are specified in the file whose name is given in Parameter 2. When a filename 
template "ag1.grd" is given in this parameter, the output filenames may look like "ag1.grd, ag2, ...,
ag108.grd" (108 x 1 = 108 files in total), if 108 different rotational positions, with 1 defocus distances
at each rotational position, are specified in the file whose name is given in Parameter 2. In particular,
in the first case the number of digits in each of the two indexes is always the same, which is 
achieved by padding with leading zeros as necessary, while in the second case the zero padding is
not used (as a consequence of the given file name template, and consequently the number of digits 
in the two indexes may vary depending on the magnitude of a particular index. If index padding was desired
in the second case, the file name template could be changed to "ag001.grd". The first version of the
template interpretation (with zero padding) is also used by default, e.g. when no digits are present 
in the template file name just before the file extension (as in ag1a.grd). 
See the description of GRD and GRC file formats and an example DefocusRand36_NEW.txt file below. 
Note that when input defocused complex amplitudes are specified, there can be only one GRC file 
per illumination direction, and the subsequent 2D phase retrieval (see below) is skipped. The reason for
such a behaviour of the program is that each complex amplitude is assumed to contain the correct complex
wavefunction at the given orientaion and the defocused distance. In principle, this complex amplitude 
can be propagated to any other defocused distance by calculating Fresnel diffraction integrals. In particular,
no phase retrieval is required in this case. Obviously, such GRC (complex amplitude) input is intended
for testing and debugging purposes only, since only defocused intensities are expected to be available
under experimentally-relevant conditions.

Parameter 5 contains the parameters required for correct interpretation of the data provided in RAW input
data files. These parameters include the length of the optional file header (in bytes), the endianness of
the file (0 = little endian, 1 = big endian) and the size of each file element, i.e. each pixel value (in bytes).
The last parameter can only be equal to the length of single-precision or double-precision floating-point numbers
on a given machine. The endianness of the data file must coincide with the endianness of the current computer / OS.
This will be checked, but no endianness conversion will be performed. The file header is read, but not used in this program.

Parameter 6 contains the width(X) and the height(Y) of the image in pixels. If an input file contains an image with larger
dimensions, it will be truncated to the values given in Parameter 6. If an image file contains an image with smaller
dimensions than those given in Parameter 6, an exception will be thrown and the program will fail. If an input image is given
in a RAW format, it will be interpreted according to the values given in Parameter 6 when reading the file.

Parameter 7 contains the physical linear size (in angstroms) of the (square) pixels of the images specified
in Parameter 4. When the input images are given in GRD or GRC format, which contain the physical dimensions of the images
internally, that internal information is ignored and replaced by the values obtained from Parameter 7 in combination with
the values in Parameter 6.

Parameter 8 contains user-definable x, y and z shifts of the centre of rotation (in Angstroms). The default
values of all zeros correspond to the centre of rotation located at the centre of the reconstruction volume.

Parameter 9 contains the input data normalization factors f1 and f2. The data read from the input data files
is rescaled according to: input -> (input / f1) + f2. For the input data to be not rescaled, the two numbers
specified in Parameter 9 should be f2 = 1 and f2 = 0. Note that several algorithms implemented in this software
require the incident intensity to be uniform 1.0. This normalization should take this into account.

Parameter 10 contains the wavelength of the illuminating wave in angstroms. 

Parameter 11 contains the objective aperture in milliradians. Zero or negative value here is 
interpreted as an infinite aperture.

Parameter 12 contains the values of the spherical aberrations Cs3 and Cs5 (in millimetres) of 
the imaging system. Zero values correspond to the absence of aberrations.

Parameter 13 contains the value of the absorption coefficient in the form of a fraction of the real increment of
the refractive index, i.e. if n = 1 + delta + i beta, then this coefficient is equal to beta / delta. The value must
be between -1 and 1 (inclusive). Typical value for electron microscopy is between zero and 0.1. At this time,
the absorption coefficient is only taken into account in the methods corresponding to Parameter 14 equal to 4 and 5.

Parameter 14 can be equal to 1, 2, 3, 4 or 5. It determines the 2D phase retrieval method to be used as 
part of the DHT algorithm internally in the PhaseRetrieval.exe program. Methods 1 and 2
can be used only in the case when there 2 or more defocused images per each illumination directon,
while the methods 3, 4 and 5 can be used only when there is 1 defocused image at each illumination direction. 
"1" corresponds to the IWFR phase retrieval method [L. J. Allen, W. McBride, N. L. O'Leary
and  M. P. Oxley, Ultramicroscopy 100 (2004) 91-104.]. 
"2" corresponds to the CTF phase retrieval method, which has been adopted from
[D. Paganin, A. Barty, P. J. Mcmahon and K. A. Nugent, Quantitative phase-amplitude microscopy. III. 
The effects of noise, J. Micros. (2004) 51-61.], for the cases where the number of defocused images per illumination
direction is equal to 2 or more.
"3" corresponds to the retrieval of conjugated phase from a single defocused image as Phase~ = -0.5 * (Intensity / I0 - 1).
"4" corresponds to variable-distance CTF correction method: Weak Phase Object CTF correction is applied according
to different distances between the image plane and different transverse planes in the reconstructed volume, if Parameter 15
is equal to 1. If Parameter 15 is equal to 0, the same CTF correction, corresponding to the distance to centre of 
the reconstruction volume, is applied for all back-propagation planes (i.e. back-projection is applied instead of the
back-propagation). The latter corresponds to conventional CTF-corrected phase CT without filtering.
"5" corresponds to the "symmetrized" sCTF correction method: the 3D potential is reconstructed directly on the Ewald
sphere in the reciprocal space, summing the contribution from the Fourier transforms of all defocused images (contrast 
functions), corrected by the corresponding complex CTFs. When Parameter 15, the curvature of the Ewald sphere is
taken into account in this method, when Parameter 15 is equal to 0, the Ewald sphere curvature is set to zero. The latter
method corresonds to the usual CTF-corrected phase CT used e.g. in cryo-EM.
When input defocused complex amplitudes are specified in Parameter 4, and the phase retrieval method is equal to 3, 
the 2D phase retrieval step is skipped and the input complex amplitude is used in the Fresnel back-propagation step. 
When input defocused complex amplitudes are specified in Parameter 4, and the phase retrieval method is not equal 3,
an exception is thrown.

Parameter 15 can be equal to 0 or 1. If it is equal to zero, a flat Ewald sphere is assumed, i.e. the Ewald sphere curvature
correction is not applied (flat Ewald sphere imaging model is assumed). It this parameter is equal to 1, Ewald sphere
curvature correction is applied.

Parameter 16 specifies if the phase-retrieved defocused complex amplitudes or the "universal" filter matrix are to be saved
in GRC or GRD files, respectively. If this parameter is equal to 1, then the phase-retrieved defocused complex amplitudes
are saved to GRC files or the filter matrix is saved in GRD files (depending on the phase retrieval method selected
in Parameter 14). In the case of the GRC files, the names are created by modifying the input defocused intensity
filenames by changing the file extensions to ".grc" and adding the capital letter "D" before that
file extension. In the case of the GRD files, the names are created by modifying the output filenames specified
in Parameter 30 below, by changing the file extensions to ".grd" and adding the capital letters "FM" before that
file extension.

Parameter 17 specifies the maximal allowed number of iterations to be used in the IWFR algorithm or the "critical SNR"
(below which the Fourier coefficients of the reconstructed 3D potential are strongly suppressed) in the sCTF algorithm. 
This parameter is ignored when Parameter 14 is not equal to 1 or 5.

Parameter 18 specifies the following parameters, depending on the value of Parameter 14:
(a) The pre-defined minimal phase reconstruction error in the case of the IWFR algorithm.
Typical value is ~ 1.e-8. IWFR iterations are interrupted when the relative difference with 
the previous iteration becomes smaller than this value.
(b) Tikhonov regularization parameter in the case of CTFL2, vCTF and cCTF algorithms.
Typical value is ~ 1.e-12 for the CTFL2 algorithm or 0.01 for the vCTF and cCTF algorithms.
Setting this parameter to zero forces the internal implementation of the CTF correction algorithms
to use an estimated "optimal" value of this parameter which can be different at each illumination direction.
Note that in the case of vCTF and cCTF algorithms this "optimal" value is often too small and the "typical"
value 0.01 tends to produce better results.
(c) multiplication_factor "Fact" for the Min05LogAmp algorithm, such that 
Phase~ = Fact * {-0.5 * (Intensity / I0 - 1)}. Typical value is Fact = 1.0.  

Parameter 19 contains the minimum and the maximum z coordinate in angstroms for the output (xy) 
planes at which the 3D potential is reconstructed. In order to reconstruct the 3D electrostatic potential
inside a molecule of thickness D, the zmin and zmax values should normally be set to -D/2 and D/2, respectively.
Note also that this program requires the x, y and z grid steps to be the same, and it will always use
the z grid step equal to the value given in Parameter 7. 

Parameter 20 contains the "extra defocus" / "offset" distance in angstroms used in the DHT or CHR algorithms 
for 3D reconstruction. See details in [T.E. Gureyev et al., arXiv 2012.07012]. In the case of CTF correction
algorithms, this value is typically set to zero.

Parameter 21 can be equal to 0 (no symmetry enforcement will be applied), 1 (symmetry enforcement will be
applied during the reconstruction - see parameter 22 for details) or 2 (symmetry enforcement will be
applied after the 3D reconstruction or applied to a previously reconstructed 3D potential imported from
files, depending on the value of parameter 31).

Parameter 22 contains a name of an input file (in the same format as a .txt format in parameter 2 above),
with Euler rotation angles (in degrees) corresponding to 3D rotations enforcing a known symmetry of the 3D potential.
If parameter 21 is equal to 1, all input illumination angles from the file given in parameter 2
will be split into subsets assigned to each of the symmetry orientations from the file given in parameter 22,
and the reconstructed object will be rotated to the corresponding orientation for each of this subsets during
the reconstruction. If parameter 21 is equal to 2, the reconstructed or imported potential will be rotated to each one
of these angles and averaged over all such rotations. The first entry in this input symmetry file
is always expected to contain all zero angles, corresponding to the "initial" rotational position 
of the reconstructed 3D potential. Defocus distances present in the input file will be ignored.

Parameter 23 can be equal to 0 or 1. It determines if and how the inverse 3D Laplacian 
filter is applied to the 3D potential. "0" corresponds to not applying the inverse 3D Laplacian. 
"1" corresponds to applying it. Unless Parameter 14 is equal to 5, a typical usage cycle of 
PhaseRetrieval.exe may consist of an initial reconstruction of the 3D potential from defocused images
and saving them into files in the first run of PhaseRetrieval.exe, with Parameter 23 set to 0, 
Parameters 25 set to "0 0 -1.e+8" and Parameters 28 and 31 set to 0. This may be followed by a second run
(restart) of PhaseRetrieval.exe program, with a suitably modified parameter file, where 
Parameter 23 is set to 1, and Parameters 25 are set to some suitable values for background removal
and Parameter 31 set to 1. The filtered 3D potential is saved in the GRD or TIFF files in the folder
specified by Parameter 32, and with the names that are obtained from the names defined by 
Parameter 30 by inserting letter "R" at the end of the filename, immediately preceding the file extension. 
If Parameter 14 is equal to 5, it may be preferable to set Parameter 23 to 1 during the initial 
reconstruction, because in this case the inverse Laplacian can be applied very quickly and cheaply
to the 3D potential data in the Fourier space, which is intrinsically available in the course of
this reconstruction method. However, this presumes that a "good" value of Parameter 24 is already 
known. NOTE, however, that inverse Laplacian is likely to create some "anti-cupping" artefacts, because,
near the boundary, it will be avaraging with smaller values outside the boundary.

Parameter 24 contains the regularization parameter for the inverse 3D Laplacian filter. If the 
filter is not used, this parameter is ignored. Relatively large values of this parameter (1 or larger)
correspond to a "weak" effect of the inverse Laplacian filter which is not strongly affecting higher 
frequencies. Relatively small values of this parameter (say, 0.01 or smaller) usually result in
a "full-strength" application of the inverse Laplacian, with a strong low-pass filtering effect.

Parameter 25 contains the low-pass filter width in angstroms, the background subtraction value in volts and 
the lower threshold value in volts to be applied to the reconstructed 3D potential. The low-pass filter
width corresponds to the width of a 3D Gaussian with which the reconstructed 3D potential distribution
is convolved, followed by the subtraction of this low-pass filtered version of the potential from the 
original distribution of the potential. As a result, a high-pass filtering of the original 3D distribution
of the reconstructed potential is achieved, which allows one to effectively subtract away any 
slowly-varying background which may typically present due to multiple scattering or due to the insufficient
number of different orientations in the input set of defocused images. Note that the zero(0) value of
the low-pass filtering width is interpreted as "no filtering", and in this case the high-pass filtering
is not performed. A similar effect can be achieved by setting the low-pass filter width to a value that is
larger than the x-width of the reconstructed potential distribution. Following the low-pass filtering,
the background subtraction value is subtracted from the 3D potential, and any values that become lower
than the specified lower threshold value after this are replaced by this lower threshold value. 
The optimal values of the low-pass filter width, the background subtraction value and the 
lower threshold value can be determined by the user e.g. on the basis of comparison of the output 
3D potential with a priori known realistic physical values for the atomic potentials. Another method for 
fine-tuning of this scaling factor can be based on the comparison of the contrast in the re-projected 
defocused images with the contrast in the input defocused images. Note that the contrast values for the
input and re-projected defocused images are printed out by PhaseRetrieval.exe before the end of the execution,
so these can be checked by the user.

Parameter 26 can be equal to 0 or 1. When this parameter is set to 0, the multislice 
reprojection of the reconstructed 3D potential is not applied. When this parameter is set to 1, 
the multislice reprojection of the reconstructed 3D potential is applied. When this parameter 
is set to 1 and Parameter 31 is set to 1, the initial reconstruction of the 3D potential is skipped, 
the distribution of the potential is read from the files defined by Parameter 30 and the multislice 
reprojection is applied to the imported potential. This is preceded by the renormalization of the imported 
potential according to Parameter 25, with the rescaled potential saved in the GRD or TIFF files with
the names that are obtained from the names defined by Parameter 30 by inserting letter "R"
at the end of the filename, immediately preceding the file extension. When Parameter 26 is equal
to 1, the defocused complex amplitudes are calculated at the angular positions defined 
in the file specified in Parameter 2. These defocused complex amplitudes are saved in the 
GRC files with the names that correspond to those in Parameter 2, but with the file extension
always replaced by ".grc" and the letter "R" inserted at the end of the filename, immediately
preceding the file extension. These file are saved in the folder specified in Parameter 32.

Parameter 27 defines the slice thickness in angstroms for the multislice algorithm used for the 
reprojection of the reconstructed or imported 3D potential. If the reprojection is not performed,
this parameter is ignored.

Parameter 28 can be equal to 0 or 1. When this parameter is set to 0, the peak localization in
the reconstructed 3D potential is not performed. When this parameter is set to 1, 
the peak localization in the reconstructed 3D potential is performed. When this parameter 
is set to 1 and Parameter 31 is set to 1, the initial reconstruction of the 3D potential is skipped,
the distribution of the potential is read from the files defined by Parameter 30 and the peak localization is 
performed in the imported 3D potential. This is preceded by the renormalization of the imported potential 
according to Parameter 25, with the renormalized potential saved in the GRD or TIFF files in the
folder specified by Parameter 32 and with the names that are obtained from the names defined
by Parameter 30, but with inserted letter "R" at the end of the filename, 
immediately preceding the file extension. The "peak-localized" 3D potential is also saved in the
GRD or TIFF files in the folder specified by Parameter 32, and with the names that are obtained from 
the names defined by Parameter 30, but with inserted letter "A" at the end of the filename, 
immediately preceding the file extension. The positions of the located peaks, as well as their intensities,
will be also saved in a Kirkland-type XYZ molecular file, provided that the number of peaks is less
than a pre-defined maximum (currently this is set to 500,000; this is done in order to avoid extremely
large XYZ files to be saved on a hard disk, which may take a very long time and occupy a lot of disk space).
The name of this XYZ file is created from the name template defined by Parameter 30, but with inserted letter "A"
at the end of the filename, immediately preceding the file extension, which in turn is changed
to ".xyz" here. This file is also saved in the folder specified in Parameter 32.

Parameter 29 defines the transverse (x and y) and longitudinal (z) side lengths of a moving parallelepiped
area ("box") that is used for peak localization in the reconstructed or imported 3D potential. 
Note that we exclude the "atom_size"-wide vicinity of the outer boundary from this search, as we expect that
this vicinity may oten contain artefacts. If the peak localization is not performed, this parameter is ignored. 

Parameter 30 contains a fully specified pathname for the output or input files (in GRD 
format or uncompressed 32-bit floating-point TIFF format) containing 2D sections of 
the 3D electrostatic potential where the potential is either 
reconstructed by this program or was produced previously and saved in these files (the 
behaviour depends on the values of Parameter 31). Note that here the pathname 
contains a "template" for the eventual output filenames which PhaseRetrieval.exe creates by 
inserting numbers that correspond to the z-index of a (xy) plane with a 2D section of the 3D 
potential. As a result, when a filename template "out.grd" is given in this parameter, the 
actual filenames with the 3D potential may look like "out000.grd, out001.grd,..., out255.grd", 
if 256 (xy) planes are specified as a consequence of the values in Parameters 7 and 19.

Parameter 31 can be equal to 0 or 1. When this parameter is set to 0, the DHT reconstruction
of the 3D potential from defocused images is performed. When this parameter is set to 1, 
the previously calculated 3D potential is imported from files specified in Parameter 30.

Parameter 32 contains a fully specified pathname for the output of various auxiliary files. 
The specified folder must already exist in an accessible location.

Parameter 33 contains the desired number of worker threads to launch during the execution of 
PhaseRetrieval.exe. The recommend number is equal to the hyper-threading capacity of one's 
computer (often, this number is equal to the number of available CPU cores times 2), minus 1 
(one thread may be reserved for the "main user thread" that leaves the computer responsive to 
user interactions during prolonged calculations). For example, if you run PhaseRetrieval.exe 
on a PC with an Intel Core i5 CPU with 6 cores, the recommended value of this parameter is 11.
 
============================================================================================
** Example of a text file with ".txt" extenstion whose name may appear in Parameter 2 
(this is typically the same file as used in MsctKirkland.exe for the generation of the defocused
images that are used here as the input dataset, all values are given either in angstroms or degrees):

//Z_rotation	Y'_rotation	Z''_rotation1	Defocus1	Z''_rotation2	Defocus2
134.545593	20.8879562	250.2507883	8.222943558	100.118147	5.766113138
328.9524395	68.27488858	343.0435375	14.69256862	155.8774949	13.27846134
341.2124109	58.14192331	259.6780077	9.394382628	159.9422219	7.886505485
196.5382573	35.93093368	155.7524815	10.66208447	132.2968222	10.23461056
259.1734396	92.41853487	191.961092	13.05924461	21.64331534	14.06469824
100.7594369	63.88481208	291.9033034	8.891866815	289.5271391	12.0210506
323.1600184	167.2336091	276.145737	5.124502934	154.6881345	12.70999187
259.7074261	45.77533335	183.20903	12.21241235	302.7163076	6.172852555
207.5392464	68.30142143	199.7200929	9.077328511	238.9836551	11.8385373
171.1598766	89.68242302	92.48191277	6.655790719	347.0470774	11.80187741
60.55292977	25.93491786	211.3969304	7.568231724	226.5960793	5.605451246
48.85497938	31.68942623	256.624174	11.403842	87.85325344	6.75988388
357.5837845	132.619438	349.2236099	11.97751674	289.0335287	13.37860964
162.3045554	79.02550822	257.9751296	9.164385773	326.2744611	7.944083188
266.5438071	119.8127464	208.8295398	7.316264206	198.8033863	5.846068438
347.4672745	43.82225966	170.2100489	8.462136081	257.2294484	6.048567208

======================================================================================= 
** Example of a text file with ".relionnew" extension whose name may appear in Parameter 2. All numeric parameter values are given either in angstroms or degrees.
The entries in each line are as following: 'index','rlnImageName','rlnOriginXAngst','rlnOriginYAngst','rlnDefocusU','rlnDefocusV','rlnDefocusAngle','rlnAngleRot','rlnAngleTilt','rlnAnglePsi'

0 000027@Extract/job028/raw_data/FoilHole_24015511_Data_24016401_24016403_20200225_0229_Fractions.mrcs 6.0747860000000005 5.763797 -4733.33691 -4973.70459 -1.0750600000000001 56.901502 49.038866 -48.524609999999996
1 000084@Extract/job028/raw_data/FoilHole_24979112_Data_24016511_24016513_20200225_0900_Fractions.mrcs 3.954763 -1.84023 10492.974609 10432.435547 -75.39655 131.376496 40.427904999999996 -89.30115
2 000097@Extract/job028/raw_data/FoilHole_24015641_Data_24016401_24016403_20200225_0336_Fractions.mrcs 0.27979699999999996 -3.8142400000000003 7113.157227 6892.040039 -83.40009 108.881904 24.085185 -110.51613
3 000006@Extract/job028/raw_data/FoilHole_24978107_Data_24016511_24016513_20200225_0556_Fractions.mrcs 1.8157740000000002 3.186774 5342.791015999999 5342.791015999999 46.90181 47.026806 6.831614999999999 125.40969399999999
4 000114@Extract/job028/raw_data/FoilHole_25057719_Data_24016511_24016513_20200226_1052_Fractions.mrcs -1.0722399999999999 -0.61524 9617.179688 9452.393555 -69.36966 93.474083 36.806884000000004 7.076600999999999
5 000089@Extract/job028/raw_data/FoilHole_25056872_Data_24016511_24016513_20200226_0928_Fractions.mrcs -1.6942099999999998 0.5907859999999999 4516.510742 4149.159668 -87.56658 48.633057 27.932356 -33.94515
6 000047@Extract/job028/raw_data/FoilHole_24979126_Data_24016401_24016403_20200225_0918_Fractions.mrcs -3.8332 1.047786 1699.285645 1511.013916 -3.4231199999999995 123.60555 47.735718 82.492642
7 000003@Extract/job028/raw_data/FoilHole_25040917_Data_24016401_24016403_20200225_2010_Fractions.mrcs 0.444774 7.445786 1898.1109620000002 1568.910889 -89.99998000000001 64.82292 32.071253000000006 -51.04459
8 000090@Extract/job028/raw_data/FoilHole_25057807_Data_24016511_24016513_20200226_1229_Fractions.mrcs 0.5907859999999999 3.186774 3255.9536129999997 2939.893311 89.999992 118.02816399999999 26.318164000000003 -126.2512
9 000036@Extract/job028/raw_data/FoilHole_25040886_Data_24016401_24016403_20200225_1941_Fractions.mrcs -5.496230000000001 6.988786 3605.345703 3256.579346 -86.0445 95.15947299999999 20.568626000000002 57.112438
10 000068@Extract/job028/raw_data/FoilHole_24015642_Data_24016511_24016513_20200225_0337_Fractions.mrcs -9.7742 0.298763 8800.291992 8632.805664 -80.19451 80.50514799999999 43.051194 -156.06998000000002

======================================================================================= 
** Example of a text file with ".relionnew" extension whose name may appear in Parameter 3.
6604	2.90E-02
2962	2.86E-02
9268	2.74E-02
9337	2.73E-02
9864	2.68E-02
9421	2.36E-02
2657	2.33E-02
2187	2.24E-02

=============================================================================== 
Specifications of the GRD file format:

GRD files contain:
(1) string "DSAA" or "DSBB" (in ASC and BIN GRD files, respectively)
(2) nx ny - array dimensions as "short"s (in ASC format, separated by a white space)
(3) xlo xhi - lower and higher X boundaries as "double"s (in ASC format, separated by a 
white space)
(4) ylo yhi - lower and higher Y boundaries as "double"s (in ASC format, separated by a 
white space)
(5) zlo zhi - minimum and maximum array value as "double"s (in ASC format, separated by a 
white space)
(6) u[i][j] - array values as "float"s (in ASC format, separated by a white space), j index 
changes most rapidly
 
=================================================================================
Specifications of the GRC file format

GRC files contain:
(1) -5 - as a "short" value (this is the GRC file format identifier)
(2) wl - wavelength as a "double"
(3) nx ny - array dimensions as "short"s (in ASC format, separated by a white space)
(4) xlo xhi - lower and higher X boundaries as "double"s (in ASC format, separated by a 
white space)
(5) ylo yhi - lower and higher Y boundaries as "double"s (in ASC format, separated by a 
white space)
(6) real(u[i][j]) imag(u[i][j]) - real and imaginary parts of array values as "float"s (in ASC 
format, separated by a white space), j index changes most rapidly.